#!/bin/bash

source "${BASH_SOURCE%/*}/lib/utils.sh"

if [ -z "$DOTFILES_ROOT" ]; then
    echo "Invalid root directory."
    exit 1
fi

for dotfile in $(dotfiles $DOTFILES_SRC); do
    BACKUP=false

    # Detect if there's a file already there.
    if [[ -e ~/.$dotfile ]]; then

        # is it a symlink? is it poiting to the dotfile dir?
        dotfile_realpath=$(pwd -P `readlink ~/.$dotfile | xargs dirname $1`)
        if [ -L ~/.$dotfile -a "$dotfile_realpath" == "$DOTFILES_ROOT" ]; then
            echo "Skipped $dotfile"
            continue
        else
            # that dotfile has nothing to do with us, better make a backup.
            mv ~/.$dotfile ~/.$dotfile.orig
            BACKUP=true
        fi
    fi
    ln -s $DOTFILES_SRC/$dotfile ~/.$dotfile
    printf "Symlinked $dotfile. "

    $BACKUP &&  printf "(A backup was saved)."
	echo # echoes a blank line no matter what

done

# run installation
source "$DOTFILES_LIB/install.sh"
