#!/usr/bin/env bash
set -e

# Load utils
_path=$(readlink -n ${BASH_SOURCE[0]} 2> /dev/null)
[[ -z "$_path" ]] && \
    echo "bash_profile must be a link, did you install the dotfiles correctly?" && \
    exit 1
_path=$(cd $(dirname $0)/$(dirname $_path)/../lib && pwd)
[[ ! -d $_path ]] && echo "$_path should be a directory." && exit 1
source $_path/utils.sh

for i in "$@"; do
    case $i in
        --force=*) _force="${i#*=}" && shift ;;
        --skip=*) _skip="${i#*=}" && shift ;;
    esac
done

# Install symlinks
inCSV $_skip 'links' || source $DOTFILES_LIB/install-links.sh

# Install packages
isDarwin && source $_path/../lib/install-darwin.sh
isArch && source $_path/../lib/install-arch.sh

# Install the default version of Node
if hash nvm 2> /dev/null && [ -z $(nvm ls default) ]; then
	echo "Enabling latest version of node"
	target=$(nvm ls-remote | tail -1 | xargs)
	nvm install $target
	nvm alias default $target
fi

# Nvim's addons
if hash nvim 2> /dev/null; then
	echo "Installing/upgrading pyton-base and neovim"
	pip3 install --upgrade setuptools pip neovim

	# Nvim's plugin manager
	[ ! -f ~/.vim/autoload/plug.vim ] && \
		echo "Installing vim's plugin manager" && \
		curl -fLo ~/.config/nvim/autoload/plug.vim --create-dirs \
			https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim

	echo "Installing vim plugins"
	nvim +PlugInstall +UpdateRemotePlugins  +qall

fi

