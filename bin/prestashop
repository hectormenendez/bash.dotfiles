#!/bin/bash
target=$2

[[ -z $target ]] && target=/srv/http/llevele.mx

[[ -z $1 ]] && echo "Error: Command required" && exit 1

function __chmod {
    [[ $(whoami) != "root" ]] && echo "Error: sudo required" && exit 1
    chmod -Rv g+u,o-rwx $target | grep "changed from" 
}

function __chown {
    [[ $(whoami) != "root" ]] && echo "Error: sudo required" && exit 1
    chown -Rv http:http $target | grep -v "retained as"
}

function __ddrop {
    mysql -u root -p --database=llevele --execute "DROP DATABASE llevele; CREATE DATABASE llevele; GRANT ALL ON llevele.* to 'llevele'@'localhost'; FLUSH PRIVILEGES;"
}

function __ddump {
    local ref=$(git rev-parse --verify HEAD)
    mkdir -p /srv/http/llevele.mx/public_html/.prestashop-dumps 2> /dev/null
    mysqldump -h localhost -u llevele -p llevele > /srv/http/llevele.mx/public_html/.prestashop-dumps/$ref.sql
}

function __gdump {
    local ref=$(git rev-parse --verify HEAD)
    git add .prestashop-dumps
    git commit -m "Added dump for: $ref"
}

function __gdrop {
    git reset --hard $(git rev-list HEAD | tail -n 1)
    git clean -dfx
    __chown
    __chmod
}

function __gls {
    git log --pretty=oneline
}

function __gtree {
    git log --graph --oneline --all
}

[[ $1 == "chmod" ]] && __chmod
[[ $1 == "chown" ]] && __chown
[[ $1 == "ddrop" ]] && __ddrop
[[ $1 == "gdrop" ]] && __gdrop
[[ $1 == "ddump" ]] && __ddump
[[ $1 == "gdump" ]] && __gdump
[[ $1 == "gls"   ]] && __gls
[[ $1 == "gtree" ]] && __gtree

if [[ $1 == "ch" ]]; then
    __chmod
    __chown
fi

if [[ $1 == "drop" ]]; then 
    __ddrop
    __gdrop
fi

if [[ $1 == "dump" ]]; then
    __ddump
    __gdrop
fi

if [[ $1 == "save" ]]; then
    git add -A
    read -p "What changed? Â»" MESSAGE
    git commit -m "Commited change: $MESSAGE"
    __ddump
    __gdump
    echo "Snapshot saved."
    echo "Just to be sure, run 'ch' with sudo to ensure file permissions."
fi
