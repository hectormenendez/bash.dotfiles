# Quick hack for Mac
[[ `uname` == 'Darwin' ]] &&  alias readlink=greadlink

# Get directory, where the script files resides
__filename=${BASH_SOURCE[0]}
__dirname=`dirname $(readlink -f $__filename)`
__libpath=`realpath "$__dirname/../lib"`

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

# Include utilities
source "$__libpath/utils.sh"

# Environment variables
export DOTFILES=$__dirname
export NVM_DIR=~/.nvm

if $(isLinux); then
	export LC_ALL=en_US.UTF-8
	export LANG=en_US.UTF-8
	export PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/bin:/usr/sbin:/sbin
else
	export HOMEBREW_GITHUB_API_TOKEN=04aea4ea0e1826957f542cfc959bd9ee12c3c545
	export PATH=$(brew --prefix coreutils)/libexec/gnubin:$HOME/.nodebrew/current/bin:$PATH
fi

# Set the creation mask, so files are created with 600 and dirs as 700
umask 077

# Shell options
shopt -s checkwinsize # check winsize after each command and adjust screen automatically,
shopt -s nocaseglob   # case insensitive globbing
shopt -s cdspell      # Autocorrect typos in path names when using cd

# set file colors
eval `dircolors ~/.dir_colors`

# History management:
# cleanup the history file, by manually removing dups
tac $HISTFILE | awk '!x[$0]++' | tac | sponge $HISTFILE

# don't put duplicate lines in the history and erase those that already exist
# don't overwrite history on login, append to it.
HISTCONTROL=erasedups:ignorespace
shopt -s histappend
PROMPT_COMMAND="history -n; history -w; history -c; history -r; $PROMPT_COMMAND"

# Add tab completions for SSH hostnames based on ~/.ssh/config
[ -e "$HOME/.ssh/config" ] && complete -o "default" -o "nospace" -W "$(grep "^Host" ~/.ssh/config | grep -v "[?*]" | cut -d " " -f2- | tr ' ' '\n')" scp sftp ssh;

# make less more friendly for non-text input files, see lesspipe(1)
[ -x /usr/bin/lesspipe ] && eval "$(SHELL=/bin/sh lesspipe)"

# set color command prompt
export PS1='\[\033[01;30m\]\h \[\033[01;34m\]\w\[\033[00m\]\n\$ '

# Prepend git branch name on command prompt.
[ -r "$__libpath/git/prompt.sh" ] && source "$__libpath/git/prompt.sh"

# If an alias file exists, load it.
[ -f ~/.alias ] && source ~/.alias

# MacOnly
if ! $(isLinux); then

	# Enable bash completion
	if [ -f $(brew --prefix)/etc/bash_completion ]; then
		source $(brew --prefix)/etc/bash_completion
	fi

	# Load NVM if avilable
	[ -s "$(brew --prefix nvm)/nvm.sh" ] && source "$(brew --prefix nvm)/nvm.sh"

else

	# Load NVM if avilable
	[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

fi
